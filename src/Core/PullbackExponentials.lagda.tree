\title{Pullback Exponentials}
\taxon{Module}
\date{2026-02-19}
\author{fredrikbakke}

\import{stt-macros}

%```agda
\agda{
module Core.PullbackExponentials where

open import ufAxioms

open import Foundations.Prelude
open import Foundations.TypeFamilies

open import Ergonomics.Extensionality
}
%```

\subtree{
\taxon{Definition}
\title{The \code{Const} Family}

\p{
Given a map #{f : A â†’ B}, we consider a type of \em{constancies} of #{f},
#{Î£ (b : B), ((a : A) â†’ f\,a = b)}.

}

%```agda
\agda{
module _
  {ğ“¤1 ğ“¤2 : Level}
  {A : Type ğ“¤1}
  {B : Type ğ“¤2}
  where

  fam-Const : (A â†’ B) â†’ B â†’ Type (ğ“¤1 âŠ” ğ“¤2)
  fam-Const f b = (a : A) â†’ f a ï¼ b

  Const : (A â†’ B) â†’ Type (ğ“¤1 âŠ” ğ“¤2)
  Const f = Î£[ b âˆ¶ B ] (fam-Const f b)

  Const-path-coe-fam-Const
    : {f : A â†’ B}
      {c l : B}
      (h : fam-Const f c)
      (t : c ï¼ l)
    â†’ (Î» a â†’ h a âˆ™ t) ï¼ coe (ap (fam-Const f) t) h
  Const-path-coe-fam-Const h refl = funextâ†’ (Î» a â†’ âˆ™-reflr (h a))

  Const-path-IdPâ‰ƒpointwise
    : {f : A â†’ B}
      {c l : B}
      (h : fam-Const f c)
      (r : fam-Const f l)
      (t : c ï¼ l)
    â†’ IdP (ap (fam-Const f) t) h r â‰ƒ ((a : A) â†’ h a âˆ™ t ï¼ r a)
  Const-path-IdPâ‰ƒpointwise {f = f} h r t
    = IdP (ap (fam-Const f) t) h r â‰ƒâŸ¨ ï¼-postcomp-â‰ƒ (Const-path-coe-fam-Const h t) âŸ©
      ((Î» a â†’ h a âˆ™ t) ï¼ r)       â‰ƒâŸ¨ funextâ‰ƒ âŸ©
      ((a : A) â†’ h a âˆ™ t ï¼ r a)   â‰ƒâˆ

  Const-pathâ‰ƒ
    : {f : A â†’ B}
      {c l : B}
      (h : f ~ const B A c)
      (r : f ~ const B A l)
    â†’ ((c , h) ï¼ (l , r))
    â‰ƒ (Î£[ t âˆ¶ c ï¼ l ] ((a : A) â†’ h a âˆ™ t ï¼ r a))
  Const-pathâ‰ƒ {f = f} {c} {l} h r
    = ((c , h) ï¼ (l , r))                           â‰ƒâŸ¨ Î£-path eâ»Â¹ âŸ©
      (Î£[ t âˆ¶ c ï¼ l ] IdP (ap (fam-Const f) t) h r) â‰ƒâŸ¨ Î£-ap-â‰ƒ (Const-path-IdPâ‰ƒpointwise h r) âŸ©
      (Î£[ t âˆ¶ c ï¼ l ] ((a : A) â†’ h a âˆ™ t ï¼ r a))   â‰ƒâˆ
}
%```
}

\subtree{
\taxon{Definition}
\title{Dependent pullback-exponential families}

Given a type family #{B : A â†’ ğ’°} and a dependent type family over #{B},
#{Y : (a : A) â†’ X\,a â†’ ğ’±}, then we define the
\em{dependent pullback-exponential family} #{Î Ì‚_B Y} to be the family

##{Î Ì‚_B Y \coloneqq ((i , j) : Î£ (i : (a : A) â†’ X\,a), ((a : A) â†’ B\,a â†’ Y\,a\,(i\,a))) â†¦ Î£ (y : (a : A) â†’ Y\,a\,(i\,a)), ((a : A) â†’ j\,a âˆ¼ \const(y\,a))}

%```agda
\agda{
module _
  {ğ“¤1 ğ“¤2 ğ“¤3 ğ“¤4 : Level}
  (F@(A , B) : Fam ğ“¤1 ğ“¤2)
  (G@(X , Y) : DepFam ğ“¤3 ğ“¤4 F)
  where

  homáµˆá¶  : Type (ğ“¤1 âŠ” ğ“¤2 âŠ” ğ“¤3 âŠ” ğ“¤4)
  homáµˆá¶  = Î£ ((a : A) â†’ X a) (Î» i â†’ (a : A) â†’ B a â†’ Y a (i a))

  base-Î Ì‚á¶  : Type (ğ“¤1 âŠ” ğ“¤2 âŠ” ğ“¤3 âŠ” ğ“¤4)
  base-Î Ì‚á¶  = homáµˆá¶ 

  fam-Î Ì‚á¶  : base-Î Ì‚á¶  â†’ Type (ğ“¤1 âŠ” ğ“¤2 âŠ” ğ“¤4)
  fam-Î Ì‚á¶  (i , j)
    = Î£ ((a : A) â†’ Y a (i a))
        (Î» y â†’ (a : A) â†’ j a ~ const _ _ (y a))

  Î Ì‚á¶  : Fam (ğ“¤1 âŠ” ğ“¤2 âŠ” ğ“¤3 âŠ” ğ“¤4) (ğ“¤1 âŠ” ğ“¤2 âŠ” ğ“¤4)
  Î Ì‚á¶  = base-Î Ì‚á¶  , fam-Î Ì‚á¶ 

module _
  {ğ“¤1 ğ“¤2 ğ“¤3 ğ“¤4 ğ“¤5 ğ“¤6 : Level}
  (F@(A , B) : Fam ğ“¤1 ğ“¤2)
  (G@(X , Y) : DepFam ğ“¤3 ğ“¤4 F)
  (H@(U , V) : DepÂ²Fam ğ“¤5 ğ“¤6 F G)
  where

  Î Ì‚áµˆá¶  : DepFam (ğ“¤3 âŠ” ğ“¤4 âŠ” ğ“¤5 âŠ” ğ“¤6) (ğ“¤3 âŠ” ğ“¤4 âŠ” ğ“¤6) F
  Î Ì‚áµˆá¶ 
    = (Î» a â†’ Î£ ((x : X a) â†’ U a x) (Î» i â†’ (x : X a) â†’ Y a x â†’ V a x (i x)))
    , (Î» a ij@(i , j) â†’ (x : X a) â†’ Const (j x))

  Î Ì‚Î Ì‚á¶  : Fam (ğ“¤1 âŠ” ğ“¤2 âŠ” ğ“¤3 âŠ” ğ“¤4 âŠ” ğ“¤5 âŠ” ğ“¤6)
            (ğ“¤1 âŠ” ğ“¤2 âŠ” ğ“¤3 âŠ” ğ“¤4 âŠ” ğ“¤6)
  Î Ì‚Î Ì‚á¶  = Î Ì‚á¶  F Î Ì‚áµˆá¶ 

  Î Ì‚áµˆá¶ '
    : DepFam (ğ“¤3 âŠ” ğ“¤4 âŠ” ğ“¤5 âŠ” ğ“¤6) (ğ“¤3 âŠ” ğ“¤4 âŠ” ğ“¤6) F
  Î Ì‚áµˆá¶ '
    = (Î» a â†’ fst (Î Ì‚á¶  (X a , Y a) (U a , V a)))
    , (Î» a â†’ snd (Î Ì‚á¶  (X a , Y a) (U a , V a)))

  Î Ì‚Î Ì‚á¶ ' : Fam (ğ“¤1 âŠ” ğ“¤2 âŠ” ğ“¤3 âŠ” ğ“¤4 âŠ” ğ“¤5 âŠ” ğ“¤6)
            (ğ“¤1 âŠ” ğ“¤2 âŠ” ğ“¤3 âŠ” ğ“¤4 âŠ” ğ“¤6)
  Î Ì‚Î Ì‚á¶ ' = Î Ì‚á¶  F Î Ì‚áµˆá¶ '
}
%```
}

\subtree{
\taxon{Definition}
\title{The nondependent pullback-exponential}

%```agda
\agda{
infixl 40 âŸ¨_,á¶ _âŸ©

âŸ¨_,á¶ _âŸ©
  : {ğ“¤1 ğ“¤2 ğ“¤3 ğ“¤4 : Level}
  â†’ Fam ğ“¤1 ğ“¤2
  â†’ Fam ğ“¤3 ğ“¤4
  â†’ Fam (ğ“¤1 âŠ” ğ“¤2 âŠ” ğ“¤3 âŠ” ğ“¤4) (ğ“¤1 âŠ” ğ“¤2 âŠ” ğ“¤4)
âŸ¨ F ,á¶  H âŸ© = Î Ì‚á¶  F (Famâ†’DepFam F H)
}
%```
}

\subtree{
\taxon{Lemma}
\title{\(Î Ì‚\) preserves equivalences of dependent type families over a fixed base family}

\p{
For a fixed base type family #{F}, any equivalence between dependent families over
#{F}, #{G â‰ƒ H} gives an equivalence #{Î Ì‚\,F\,G â‰ƒ Î Ì‚\,F\,H}.
}
%```agda
\agda{
module _
  {ğ“¤1 ğ“¤2 ğ“¤3 ğ“¤4 ğ“¤5 ğ“¤6 : Level}
  (F@(A , B) : Fam ğ“¤1 ğ“¤2)
  (G@(X , Y) : DepFam ğ“¤3 ğ“¤4 F)
  (H@(U , V) : DepFam ğ“¤5 ğ“¤6 F)
  (e : G â‰ƒáµˆá¶ âŸ¦ F âŸ§ H)
  where

  Î Ì‚á¶ -ap-â‰ƒáµˆá¶ -base-over
    : (i : (a : A) â†’ X a)
    â†’ ((a : A) â†’ B a â†’ Y a (i a))
    â‰ƒ ((a : A) â†’ B a â†’ V a (e a .fst ._â‰ƒ_.fwd (i a)))
  Î Ì‚á¶ -ap-â‰ƒáµˆá¶ -base-over i
    = Î -ap-â‰ƒ (Î» a â†’ Î -ap-â‰ƒ (Î» _ â†’ e a .snd (i a)))

  Î Ì‚á¶ -ap-â‰ƒáµˆá¶ -base
    : fst (Î Ì‚á¶  F G) â‰ƒ fst (Î Ì‚á¶  F H)
  Î Ì‚á¶ -ap-â‰ƒáµˆá¶ -base
    = Î£-ap-â‰ƒ Î Ì‚á¶ -ap-â‰ƒáµˆá¶ -base-over
    âˆ™â‰ƒ Î£-ap-â‰ƒ-fst (Î -ap-â‰ƒ (Î» a â†’ e a .fst))

  Î Ì‚á¶ -ap-â‰ƒáµˆá¶ -family-over
    : (i : (a : A) â†’ X a)
    â†’ (j : (a : A) â†’ B a â†’ Y a (i a))
    â†’ (y : (a : A) â†’ Y a (i a))
    â†’ ((a : A) â†’ j a ~ const _ _ (y a))
    â‰ƒ ((a : A) â†’ (Î» b â†’ e a .snd (i a) ._â‰ƒ_.fwd (j a b))
               ~ const _ _ (e a .snd (i a) ._â‰ƒ_.fwd (y a)))
  Î Ì‚á¶ -ap-â‰ƒáµˆá¶ -family-over i j y
    = Î -ap-â‰ƒ (Î» a â†’ Î -ap-â‰ƒ (Î» b â†’ ï¼-equiv (e a .snd (i a))))

  Î Ì‚á¶ -ap-â‰ƒáµˆá¶ -family
    : (fp : fst (Î Ì‚á¶  F G))
    â†’ snd (Î Ì‚á¶  F G) fp â‰ƒ snd (Î Ì‚á¶  F H) (Î Ì‚á¶ -ap-â‰ƒáµˆá¶ -base ._â‰ƒ_.fwd fp)
  Î Ì‚á¶ -ap-â‰ƒáµˆá¶ -family (i , j)
    = Î£-ap-â‰ƒ (Î Ì‚á¶ -ap-â‰ƒáµˆá¶ -family-over i j)
    âˆ™â‰ƒ Î£-ap-â‰ƒ-fst (Î -ap-â‰ƒ (Î» a â†’ e a .snd (i a)))

  Î Ì‚á¶ -ap-â‰ƒáµˆá¶  : Î Ì‚á¶  F G â‰ƒá¶  Î Ì‚á¶  F H
  Î Ì‚á¶ -ap-â‰ƒáµˆá¶  = Î Ì‚á¶ -ap-â‰ƒáµˆá¶ -base , Î Ì‚á¶ -ap-â‰ƒáµˆá¶ -family
}
%```
}

\subtree{
\taxon{Lemma}
\title{Fubini law for \(Î Ì‚\)}

\p{
Given a family #{F}, a dependent family #{G} over #{F}, and a dependent
family #{H} over \#{G}, there is an equivalence
##{Î Ì‚\,F\,(Î Ì‚\,G\,H) â‰ƒ Î Ì‚\,F\,(Î Ì‚_*\,G\,H)}

where #{Î Ì‚_*} is the pointwise dependent pullback-exponential.
}
%```agda
\agda{
module _
  {ğ“¤1 ğ“¤2 ğ“¤3 ğ“¤4 ğ“¤5 ğ“¤6 : Level}
  (F@(A , B) : Fam ğ“¤1 ğ“¤2)
  (G@(X , Y) : DepFam ğ“¤3 ğ“¤4 F)
  (H@(U , V) : DepÂ²Fam ğ“¤5 ğ“¤6 F G)
  (let Î Â² = Î Ì‚Î Ì‚á¶  F G H)
  (let Î Î  = Î Ì‚Î Ì‚á¶ ' F G H)
  where

  Î Ì‚áµˆá¶ â‰ƒÎ Ì‚áµˆá¶ '
    : Î Ì‚áµˆá¶  F G H â‰ƒáµˆá¶ âŸ¦ F âŸ§ Î Ì‚áµˆá¶ ' F G H
  Î Ì‚áµˆá¶ â‰ƒÎ Ì‚áµˆá¶ ' a
    = idequiv
    , (Î» (i , j) â†’ Î£-Î -swapâ‰ƒ (Î» x â†’ V a x (i x)) (Î» x l â†’ (y : Y a x) â†’ j x y ï¼ l))

  Î Ì‚á¶ -fubiniâ‰ƒ
    : Î Â² â‰ƒá¶  Î Î 
  Î Ì‚á¶ -fubiniâ‰ƒ = Î Ì‚á¶ -ap-â‰ƒáµˆá¶  F (Î Ì‚áµˆá¶  F G H) (Î Ì‚áµˆá¶ ' F G H) Î Ì‚áµˆá¶ â‰ƒÎ Ì‚áµˆá¶ '
}
%```
}
