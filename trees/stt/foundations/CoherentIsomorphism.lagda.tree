\date{2025-02-22}
\title{Coherent Isomorphism}

\import{stt-macros}

% ```agda
\agda{
module foundations.CoherentIsomorphism where

open import foundations.universe
open import foundations.QuasiIsomorphism
open import foundations.Sigma
open import foundations.Functions
open import foundations.FunctionInverses
open import foundations.Homotopy
open import foundations.Identity
open import foundations.PathReasoning
}
% ```

\p{We can upgrade [quasi isomorphism](QuasiIsomorphism.lagda) into a [correct notion of equivalence](st-????) by adding an extra coherence condition, that makes it into a proposition. }

\subtree[stt-000K]{
\taxon{remark}
\title{Half adjoint equivalence}

\p{The defintion of a quasi isomorphism involves:}

\ul{
\li{#{f : A \to B}}
\li{#{g : B \to A}}
\li{#{\eta : f \circ g = \id}}
\li{#{\varepsilon : \id = g \circ f}}
}

\p{The names #{\eta} and #{\varepsilon} remind us that this looks like the data of an adjunction. But we are missing the laws, often called the zig-zag laws. One of which state that the following 2-cell contracts to the identity:
}

\quiver{
% https://q.uiver.app/#q=WzAsNCxbMCwwLCJBIl0sWzIsMiwiQiJdLFs0LDAsIkEiXSxbNiwyLCJCIl0sWzAsMSwiZiIsMl0sWzEsMiwiZyIsMl0sWzIsMywiZiIsMl0sWzAsMiwiXFxpZCIsMCx7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6Im5vbmUifX19XSxbMSwzLCJcXGlkIiwyLHsic3R5bGUiOnsiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFswLDIsIiIsMCx7Im9mZnNldCI6LTEsInN0eWxlIjp7ImhlYWQiOnsibmFtZSI6Im5vbmUifX19XSxbMSwzLCIiLDAseyJvZmZzZXQiOi0xLCJzdHlsZSI6eyJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzcsMSwiXFx2YXJlcHNpbG9uIiwwLHsic2hvcnRlbiI6eyJzb3VyY2UiOjIwLCJ0YXJnZXQiOjMwfX1dLFsyLDgsIlxcZXRhIiwwLHsic2hvcnRlbiI6eyJzb3VyY2UiOjIwLCJ0YXJnZXQiOjIwfX1dXQ==
\begin{tikzcd}
	A &&&& A \\
	\\
	&& B &&&& B
	\arrow[""{name=0, anchor=center, inner sep=0}, no head, from=1-1, to=1-5]
	\arrow["\id", shift left, no head, from=1-1, to=1-5]
	\arrow["f"', from=1-1, to=3-3]
	\arrow["f"', from=1-5, to=3-7]
	\arrow["g"', from=3-3, to=1-5]
	\arrow[""{name=1, anchor=center, inner sep=0}, "\id"', no head, from=3-3, to=3-7]
	\arrow[shift left, no head, from=3-3, to=3-7]
	\arrow["\varepsilon", shorten <=7pt, shorten >=11pt, Rightarrow, from=0, to=3-3]
	\arrow["\eta", shorten <=7pt, shorten >=7pt, Rightarrow, from=1-5, to=1]
\end{tikzcd}
}

\p{In symbols, this is: #{f \cdot \varepsilon \circ \eta \cdot f = \id} (where #{\cdot} denotes horizontal composition and #{\circ} denotes vertical composition).}
}

\p{Note that in formalisation #{\varepsilon} is a 2-cell in the opposite direction, but since all 2-cells are invertible, this makes no difference to the definition and makes the formalization slightly smoother.}

% ```agda
\agda{
qiso-coh : âˆ€ {ğ“¤ ğ“¥} {A : Type ğ“¤} {B : Type ğ“¥} {f : A â†’ B} â†’ is-quasi-iso f â†’ Type (ğ“¤ âŠ” ğ“¥)
qiso-coh {f = f} (g , Î· , Îµ) = f â—‚ Îµ ~ Î· â–¸ f

}
% ```

\subtree{
\taxon{definition}
\title{Equivalences}

\p{Of the many equivalent notions of equivelences in HoTT, we will single out coherent isomorphisms as the default one in the library.}

% ```agda
\agda{
record is-equiv {ğ“¤ ğ“¥} {A : Type ğ“¤} {B : Type ğ“¥} (f : A â†’ B) : Type (ğ“¤ âŠ” ğ“¥) where
  constructor mk-eqv
  field
    qiso     : is-quasi-iso f
    coherent : qiso-coh qiso
  
  has-qiso : A â‰… B
  has-qiso = mk-iso f qiso
  
  open _â‰…_ has-qiso public hiding (fwd)

  Î· : f âˆ˜ bwd ~ id
  Î· x = section-fwd .snd x

  Îµ : bwd âˆ˜ f ~ id
  Îµ x = retract-fwd .snd x

record _â‰ƒ_ {ğ“¤ ğ“¥} (A : Type ğ“¤) (B : Type ğ“¥) : Type (ğ“¤ âŠ” ğ“¥) where
  constructor _,_
  field
    fwd : A â†’ B
    has-is-eqv : is-equiv fwd

  open is-equiv has-is-eqv public
    
equivâ†’qiso : âˆ€ {ğ“¤ ğ“¥} {A : Type ğ“¤} {B : Type ğ“¥} â†’ A â‰ƒ B â†’ A â‰… B
equivâ†’qiso (_ , has-is-eqv) = has-qiso where open is-equiv has-is-eqv

}
% ```
}



\subtree[stt-000J]{
\taxon{theorem}

% HoTT book. 4.2.3

\p{Every quasi-isomorphism can be upgraded to a coherent isomorphism.}

\proof{
\p{Since we (are soon to) know that being an equivalence is a proposition, and that quasi isomorphisms aren't equivalent to equivalences,
we know that whatever the map is, it cannot be a section of the obvious map #{\textrm{is-equiv}(f) \to \textrm{is-qiso}(f)}, and so as a
result we know we will have to be a bit clever about how we choose the 2-cells of our coherent isomorphism.}

\p{The proof goes through by cooking up a 2-cell #{\varepsilon} that makes the coherence go through trivially.
Working backwards, we need an #{\varepsilon '} such that #{f(\varepsilon') = \eta_f}. }


\quiver{
% https://q.uiver.app/#q=WzAsNSxbMCwwLCJmZ2YiXSxbNiwwLCJmIl0sWzEsMiwiZmdmZ2YiXSxbNCwxLCJmZ2YiXSxbNSwzLCJmZ2YiXSxbMCwxLCJmXFxldGEiXSxbMCwyLCJcXHZhcmVwc2lsb25eey0xfSBmZ2YiLDJdLFsyLDMsIlxcdmFyZXBzaWxvbiBmZ2YiXSxbMywxLCJmXFxldGEiLDJdLFswLDMsIiIsMSx7ImxldmVsIjoyLCJzdHlsZSI6eyJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzIsNCwiZmdmIFxcZXRhIiwwLHsiY3VydmUiOi0xfV0sWzQsMSwiXFx2YXJlcHNpbG9uIGYiLDIseyJjdXJ2ZSI6M31dLFs0LDMsIklJIiwyLHsic2hvcnRlbiI6eyJzb3VyY2UiOjMwLCJ0YXJnZXQiOjIwfSwibGV2ZWwiOjJ9XSxbMiw0LCJmXFxldGFfe2dmfSIsMix7ImN1cnZlIjoyfV0sWzIsOSwiSSIsMix7InNob3J0ZW4iOnsic291cmNlIjozMCwidGFyZ2V0IjozMH19XSxbMTMsMTAsIklJSSIsMix7InNob3J0ZW4iOnsic291cmNlIjoyMCwidGFyZ2V0IjoyMH19XV0=
\begin{tikzcd}
	fgf &&&&&& f \\
	&&&& fgf \\
	& fgfgf \\
	&&&&& fgf
	\arrow["{f\eta}", from=1-1, to=1-7]
	\arrow[""{name=0, anchor=center, inner sep=0}, equals, from=1-1, to=2-5]
	\arrow["{\varepsilon^{-1} fgf}"', from=1-1, to=3-2]
	\arrow["{f\eta}"', from=2-5, to=1-7]
	\arrow["{\varepsilon fgf}", from=3-2, to=2-5]
	\arrow[""{name=1, anchor=center, inner sep=0}, "{fgf \eta}", from=3-2, to=4-6]
	\arrow[""{name=2, anchor=center, inner sep=0}, "{f\eta gf}"', bend right,from=3-2, to=4-6]
	\arrow["{\varepsilon f}"', bend right, from=4-6, to=1-7]
	\arrow["2", shorten <=11pt, shorten >=8pt, Rightarrow, from=4-6, to=2-5]
	\arrow["1"', shorten <=11pt, shorten >=11pt, Rightarrow, from=3-2, to=0]
	\arrow["3"', shorten <=2pt, shorten >=2pt, Rightarrow, from=2, to=1]
\end{tikzcd}
}


\p{
Consider the above diagram, and in particular note that the lower boundary is given by morphisms of the form #{\alpha f} for some alpha.
By taking the horizontal composition of these #{\alpha}'s gives us our desired #{\epsilon' := \varepsilon^{-1} fg \cdot f \eta g \cdot \varepsilon}. It satisfies the necessary equations by the vertical composite of the cells: 
}

\ol{
\li{Trivially follws from paths forming groupoids.}
\li{The naturality of homotopies.}
\li{Lemma 2.4.3}
}

% ```agda
\agda{
qisoâ†’is-equiv : âˆ€ {ğ“¤ ğ“¥} {A : Type ğ“¤} {B : Type ğ“¥} {f : A â†’ B} â†’ is-quasi-iso f â†’ is-equiv f
qisoâ†’is-equiv {f = f} (g , Î· , Îµ) = mk-eqv qiso' coh where

  Î·' : f âˆ˜ g ~ id
  Î·' = (Î· ~â»Â¹) â–¸ f â–¸ g ~âˆ™
       f â—‚ Îµ â–¸ g       ~âˆ™
       Î·

  qiso' : is-quasi-iso f
  qiso' .fst = g
  qiso' .snd .fst = Î·'
  qiso' .snd .snd = Îµ

  lem3 : g â—‚ f â—‚ Îµ ~ Îµ â–¸ g â–¸ f
  lem3 x = sym (ap-comp g f (Îµ x)) âˆ™ n where
    n : (g âˆ˜ f â—‚ Îµ) x ï¼ (Îµ â–¸ g â–¸ f) x
    n = sym (homotopy-inverse (g âˆ˜ f) Îµ x)



  lem2 : Î· â–¸ f â–¸ g â–¸ f ~âˆ™ f â—‚ Îµ ~ f â—‚ g â—‚ f â—‚ Îµ ~âˆ™ Î· â–¸ f
  lem2 x = I âˆ™ ap (_âˆ™ (Î· (f x))) (ap-comp f g (ap f (Îµ x))) where
    I : Î· (f (g (f x))) âˆ™ (ap f (Îµ x)) ï¼
         ap (Î» z â†’ (f âˆ˜ g) z) (ap f (Îµ x)) âˆ™ Î· (f x)
    I = homotopy-natural Î· {f (g (f x))} (ap f (Îµ x))

  lem1 : f â—‚ Îµ ~
           ((Î· â–¸ f â–¸ g â–¸ f ~â»Â¹) ~âˆ™ Î· â–¸ f â–¸ g â–¸ f ~âˆ™ f â—‚ Îµ)
  lem1 a = âˆ™.insertr _ {h = Î· (f (g (f a)))} {i = sym (Î· (f (g (f a))))} (âˆ™-sym' (Î· (f (g (f a))))) {_} {ap f (Îµ a)}


  coh : qiso-coh qiso'
  coh =   (f â—‚ Îµ)                                       ~âŸ¨ lem1 âŸ©
          (Î· â–¸ f â–¸ g â–¸ f ~â»Â¹) ~âˆ™ Î· â–¸ f â–¸ g â–¸ f ~âˆ™ f â—‚ Îµ ~âŸ¨ ~refl {f = Î· â–¸ f â–¸ g â–¸ f ~â»Â¹} âŸ©~âˆ™âŸ¨ lem2 âŸ©
          (Î· â–¸ f â–¸ g â–¸ f ~â»Â¹) ~âˆ™ f â—‚ g â—‚ f â—‚ Îµ ~âˆ™ Î· â–¸ f ~âŸ¨ ~refl {f = Î· â–¸ f â–¸ g â–¸ f ~â»Â¹} âŸ©~âˆ™âŸ¨ f âŸ©~â—‚âŸ¨ lem3 âŸ©~âˆ™âŸ¨ ~refl {f = Î· â–¸ f} âŸ©
          (Î· â–¸ f â–¸ g â–¸ f ~â»Â¹) ~âˆ™ f â—‚ Îµ â–¸ g â–¸ f ~âˆ™ Î· â–¸ f ~âŸ¨âŸ©
           Î·' â–¸ f                                       ~âˆ

qisoâ†’equiv : âˆ€ {ğ“¤ ğ“¥} {A : Type ğ“¤} {B : Type ğ“¥} â†’ A â‰… B â†’ A â‰ƒ B
qisoâ†’equiv (mk-iso fwd fwd-iso) = fwd , (qisoâ†’is-equiv fwd-iso)

}
% ```


}
}

\transclude{EquivContrFibre.lagda}


\subtree{
\title{Equivalences form an #{\infty}-groupoid over types}

% ```agda
\agda{
idequiv : âˆ€ {ğ“¤} {A : Type ğ“¤} â†’ A â‰ƒ A
idequiv = id , (mk-eqv (id , ~refl , ~refl) ~refl)

equiv-comp : âˆ€ {ğ“¤ ğ“¥ ğ“¦} {A : Type ğ“¤} {B : Type ğ“¥} {C : Type ğ“¦}
             â†’ A â‰ƒ B â†’ B â‰ƒ C â†’ A â‰ƒ C
equiv-comp f g = qisoâ†’equiv (comp-iso (equivâ†’qiso f) (equivâ†’qiso g))

idâ†’equiv : âˆ€ {ğ“¤} {A B : Type ğ“¤} â†’ A ï¼ B â†’ A â‰ƒ B
idâ†’equiv refl = idequiv

_eâ»Â¹ : âˆ€ {ğ“¤ ğ“¥} {A : Type ğ“¤} {B : Type ğ“¥} â†’ A â‰ƒ B â†’ B â‰ƒ A
e eâ»Â¹ = qisoâ†’equiv (equivâ†’qiso e â‰…â»Â¹)

â‰ƒâŸ¨âŸ©-syntax : âˆ€ {ğ“¤ ğ“¥ ğ“¦} (A : Type ğ“¤) {B : Type ğ“¥} {C : Type ğ“¦}
           â†’ B â‰ƒ C â†’ A â‰ƒ B â†’ A â‰ƒ C
â‰ƒâŸ¨âŸ©-syntax A g f = equiv-comp f g


_â‰ƒâŸ¨âŸ©_ : âˆ€ {ğ“¤ ğ“¥} (A : Type ğ“¤) {B : Type ğ“¥} â†’ A â‰ƒ B â†’ A â‰ƒ B
x â‰ƒâŸ¨âŸ© xâ‰ƒy = xâ‰ƒy

_â‰ƒâˆ : âˆ€ {â„“} (A : Type â„“) â†’ A â‰ƒ A
x â‰ƒâˆ = idequiv

infix 31 _eâ»Â¹

infixr 2 â‰ƒâŸ¨âŸ©-syntax _â‰ƒâŸ¨âŸ©_
infix  3 _â‰ƒâˆ
infix 21 _â‰ƒ_

syntax â‰ƒâŸ¨âŸ©-syntax x q p = x â‰ƒâŸ¨ p âŸ© q
}
% ```

}
